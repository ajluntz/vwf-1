<!--
Copyright 2013 United States Government, as represented by the Secretary of Defense, Under
Secretary of Defense (Personnel & Readiness).

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
in compliance with the License. You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License
is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
or implied. See the License for the specific language governing permissions and limitations under
the License.
-->

<script type="text/javascript">
	var view = this;
	
	// The user login dialog
	$('#login').dialog( {
		title: 'Login',
		height: 'auto',
		modal: true,
		resizable: false,
		draggable: false,
		buttons: {

			"Login": function() {
				
				var userName = $( "#userName" ).val();

				// If the user entered something valid, proceed
				if ( !( ( userName == "Your Name" ) || ( userName == "" ) ) ) {

					// Remove ugly characters from the username
					userName = userName.replace(/ /g,"_");
					userName = userName.replace(/([^0-9A-Za-z])/g,"");

					// Close the dialog box
					$( this ).dialog("close");

					// Call the function in the model to create the new user object
					var kernel = vwf_view.kernel;
					kernel.callMethod( kernel.application(), "createUser", [ userName ] );
				}
			}
		}
	});

	// The event handler that is called whenever an event is fired from the model
	vwf_view.firedEvent = function( nodeId, eventName, eventParameters ) {

		// If the event that triggered this event handler was the creation of a new user,
		// And the event issued from this client, grab the camera from the new object to use for this user
		var clientThatIssuedEvent = this.kernel.client();
		var me = this.kernel.moniker();
		if ( ( eventName == "userCreated" ) && ( clientThatIssuedEvent == me ) ) {

			// Save the reference to the user object - this belongs to this user
			view.myUserObjectId = eventParameters[ 0 ];

			// Set the aspect ratio on the camera to match that of the html canvas
			var cameraId = vwf_view.kernel.find( view.myUserObjectId, "camera" );
			var applicationId = vwf_view.kernel.application();
			var canvas = $( "#" + applicationId );
			vwf_view.kernel.setProperty( cameraId, "aspect", canvas.width() / canvas.height() );

			// Tell the renderer to render from this camera for this user
			var rendererState = vwf_view.kernel.kernel.views[ "vwf/view/threejs" ].state;
			rendererState.cameraInUse = rendererState.nodes[ cameraId ].threeObject;

			// Save the camera id for future use
			var sceneNode = rendererState.scenes[ applicationId ];
			sceneNode.camera.ID = cameraId;
		}
	}

	// The event handler that is called whenever the user presses a key
	window.onkeydown = function( eventArg ) {

		// If this user has a user object, react accordingly to the key press as follows:
		// W,A,S,D - move forward, left, back, right
		// Q,E - rotate left, right
		// Note: In this example, translations are in world coordinates, so W,A,S,D always move the user in the
		//       same direction, regardless of which way they are facing
	 	if ( view.myUserObjectId )
			switch ( eventArg.keyCode ) {
				case 87: // 'W' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "translateBy", [ [ 0, 100, 0 ] ] );
					break;
				case 65: // 'A' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "translateBy", [ [ -100, 0, 0 ] ] );
					break;
				case 83: // 'S' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "translateBy", [ [ 0, -100, 0 ] ] );
					break;
				case 68: // 'D' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "translateBy", [ [ 100, 0, 0 ] ] );
					break;
				case 81: // 'Q' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "rotateBy", [ [ 0, 0, 1, 1 ] ] );
					break;
				case 69: // 'E' key
					vwf_view.kernel.callMethod( view.myUserObjectId, "rotateBy", [ [ 0, 0, 1, -1 ] ] );
					break;	
			}
	} //@ sourceURL=index.vwf.html
</script>

<!-- The input field for the login dialog above -->
<link rel="stylesheet" type="text/css" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css" />
<div id="login">
	<input id="userName" type="text" placeholder="Your Name">
</div>